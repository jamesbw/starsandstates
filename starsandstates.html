<!DOCTYPE html>
<meta charset="utf-8">
<head> </head>
<script src="d3.v2.min.js"></script>
<style>

.background {
  fill: none;
  pointer-events: all;
}

#states {
  fill: #aaa;
  stroke: #fff;
  stroke-width: 1.5px;
}

#states .past {
  fill: steelblue;
}

#states .new {
  fill: red;
}

#states .motion {
  fill: red;
}

#slider {
  display: inline-block;
  width: 600px;
}

#year {
  position: relative;
}


.star {
  fill: white;
  stroke: black;
}

</style>
<body>
  <div id="svg_container"></div>
  <div style="text-align:center">
    <div>Year</div>
    <div style="display: inline-block" id="year"></div>
    <div/>
<span class="years">1750</span><input id="slider" type="range" min="1750" max="2012" step="1" value="1750" style="vertical-align: bottom" /><span class="years">2012</span>
</div>
<script>

  var width = 1200,
      height = 500,
      centered;

  var projection = d3.geo.albersUsa()
      .scale(width * 2 /3 )
      .translate([0, 0]);

  var path = d3.geo.path()
      .projection(projection);

  var svg = d3.select("#svg_container").append("svg")
      .attr("width", width)
      .attr("height", height);

  svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height)

  var g = svg.append("g")
      .attr("transform", "translate(" + width * 1/ 3 + "," + height / 2 + ")")
    .append("g")
      .attr("id", "states");

  d3.json("states_geo.json", function(json) {
    g.selectAll("path")
        .data(json.features)
      .enter().append("path")
        .attr("d", path)

    features = json.features
    centroids = json.features.map(function(feature){ return { name: feature.properties.name, centroid : path.centroid(feature)} })
  });

  var flag_x = width * 2 / 3 + 50
  var flag_y = 50


  var flag = svg.append("rect")
                .attr("id", "flag")
                .style("fill", "red")
                .attr("height", "300")
                .attr("width", "300")
                .attr("transform","translate("+ flag_x +"," + flag_y +")")


  function color_states(state_names, class_name) {
    g.selectAll("path")
      .classed(class_name, function(d) { return state_names.indexOf(d.properties.name) > -1})
  }


  var join_years;
  var centroids;
  d3.json("join_years.json", function(json) { 
    join_years = json
  })

  var current_states = []


  var slider = d3.select("#slider")
  var year = d3.select("#year")
  var update_year = function(_year){
    year.text(_year)
    var slider_width = parseInt(slider.style("width").slice(0, -2))
    var min = parseInt(slider.attr("min"))
    var max = parseInt(slider.attr("max"))
    var slider_pos = (_year - min) / (max - min) * slider_width
    year.style("left", (slider_pos - slider_width / 2) + "px") 
  }
  slider.value = 1750
  update_year(parseInt(slider.value))
  slider.on("change", function(){ 
    var year = parseInt(this.value); 
    update_year(year);
    map_callback(year);
    flag_callback(year);
  }, false);


  function map_callback(year) {

    var states = join_years.filter( function(d) { return d.year <= year})
                                .map( function(d) {return d.states})
                                .reduce( function(s1, s2){ return s1.concat(s2)}, [])

    var new_states = states.filter( function(state) { return current_states.indexOf(state) < 0})

    var past_states = states.filter( function(state) { return current_states.indexOf(state) > -1})

    var states_for_this_year = join_years.filter( function(d) { return d.year === year})
                                .map( function(d) {return d.states})
                                .reduce( function(s1, s2){ return s1.concat(s2)}, [])

    current_states = states


    color_states(past_states, "past")
    color_states(new_states, "new")

    g.selectAll(".new")
     .classed("motion", true)
     .transition()
     .duration(1000)
     .attr("transform", function(d) {
       var centroid = path.centroid(d),
       x = centroid[0],
       y = centroid[1];
        return "translate(" + x + "," + y + ")"
       + "scale(" + 1.5 + ")"
       + "translate(" + -x + "," + -y + ")";
     })
     .each(function(){this.parentNode.appendChild(this)})
       .transition()
       .delay(1000)
       .duration(1000)
       .attr("transform", "")
       .each("end", function(){ 
        d3.select(this).classed("motion", false)
                       .classed("new", function(d){ return states_for_this_year.indexOf(d.properties.name) > -1})
                       .classed("past", function(d){ return states_for_this_year.indexOf(d.properties.name) < 0})
        })
    
    console.log(states_for_this_year) 
    color_states(states_for_this_year, "new")
  }

  function flag_callback(year) {

    var states = join_years.filter( function(d) { return d.year <= year})
                                .map( function(d) {return d.states})
                                .reduce( function(s1, s2){ return s1.concat(s2)}, []) 

    var data = centroids.filter( function(c){ return states.indexOf(c.name) > -1})
                                
    var selection = svg.selectAll(".star")
      .data(data, function(d){return d.name})

    selection.enter()
      .append('circle')
      .classed("star", true)
      .attr('cx', function(d){ return d.centroid[0] })
      .attr('cy', function(d){ return d.centroid[1] })
      .attr('r', 10)
      .attr("transform", "translate(" + width * 1/ 3 + "," + height / 2 + ")")

    selection.exit().remove()

    selection.transition()
      .attr('cx', function(d){ return flag_x - width * 1/ 3 + Math.random() * 300 })
      .attr('cy', function(d){ return flag_y - height / 2 + Math.random() * 300 })
      .duration(2000)
  }





  </script>


</body>
</html>